package core

import (
	"bytes"
	"context"
	"encoding/json"
	"gote/pkg/types"
	"net/http"
)

// URL - адресс Telegram Bot API
const URL = "https://api.telegram.org/bot"

type tgResponse[T any] struct {
	Ok          bool                      `json:"ok"`
	Result      T                         `json:"result"`
	Description string                    `json:"description,omitempty"`
	ErrorCode   int                       `json:"error_code,omitempty"`
	Parameters  *types.ResponseParameters `json:"parameters,omitempty"`
}
{{range .}}
// {{.Description}}
{{if .Note}}//
// {{.Note}}
//{{else}}// {{end}}
// https://core.telegram.org/bots/api#{{.Link}}
func (bot *Bot) {{.NameUpperCamelCase}}(ctx context.Context, param types.{{.NameUpperCamelCase}}) ({{.ReturnType}}, error) {
	data, err := json.Marshal(param)
	if err != nil {
		return {{.ReturnValue}}, err
	}
	
	url := URL + bot.token + "/{{.NameUpperCamelCase}}"
	req, err := http.NewRequestWithContext(ctx, "GET", url, bytes.NewBuffer(data))
	if err != nil {
		return {{.ReturnValue}}, err
	}

	req.Header.Set("Content-Type", "application/json")

	resp, err := bot.client.Do(req)
	if err != nil {
		return {{.ReturnValue}}, err
	}
	
	var result tgResponse[{{.ReturnType}}]
	if err := json.NewDecoder(resp.Body).Decode(&result); err != nil {
		return {{.ReturnValue}}, err
	}

	if err := resp.Body.Close(); err != nil {
		return result.Result, err
	}	

	return result.Result, nil
}
{{end}}
